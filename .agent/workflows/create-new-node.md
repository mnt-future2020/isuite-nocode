# Creating a New Execution Node

When adding a new node type to the workflow editor, follow these steps to ensure consistency, real-time feedback, and execution reliability.

## 1. Schema and Database
1.  **Enum Update**: Add the new node type to the `NodeType` enum in `prisma/schema.prisma`.
2.  **Sync DB**: Run `// turbo` `npx prisma db push && npx prisma generate` to update the database and Prisma client.

## 2. Real-time Infrastructure
1.  **Channel**: Create `src/inngest/channels/[node-name].ts` to define the status channel.
2.  **Server Action**: Create `src/features/executions/components/[node-name]/actions.ts` with `fetch[NodeName]RealtimeToken` to allow the frontend to subscribe to updates.

## 3. Backend Logic (Executor)
1.  **Executor**: Create `src/features/executions/components/[node-name]/executor.ts`.
    *   **CRITICAL: Unique Step IDs**: Every `step.run` or `step.ai.wrap` MUST include the `nodeId` in its ID (e.g., ``step.run(`my-task-${nodeId}`, ...)``). This prevents execution stalls.
    *   **CRITICAL: Flow Delta**: Return ONLY the new data generated by this node as a key-value pair where the key is the user-defined `variableName`. Do NOT spread the entire context.
    *   **Real-time Status**: Call `publish` with `loading`, `success`, and `error` statuses to the node's channel so users can see progress on the canvas.
2.  **Registration**: Register the executor in `src/features/executions/lib/executor-registry.ts`.

## 4. Frontend UI
1.  **Dialog**: Create `src/features/executions/components/[node-name]/dialog.tsx`.
    *   Use `ExpressionInput` for any field that supports variables.
    *   Include `NodeTester` at the bottom for isolated testing.
2.  **Node Component**: Create `src/features/executions/components/[node-name]/node.tsx`.
    *   Use `useNodeStatus` hook with your new server action to get real-time updates.
    *   Use `BaseExecutionNode` and pass the `status`.
    *   Register in `src/config/node-components.ts`.
3.  **Selector**: Add to `src/features/editor/components/add-node-button.tsx` (or wherever node selection happens).

## 5. Summary of Best Practices
*   **Variable Names**: Ensure `getNodeOutputVariables` in `src/components/variable-picker.tsx` is updated so users can discover the node's output.
*   **Handlebars/Expressions**: Use `resolveExpressions` or Handlebars consistently for dynamic text.
